---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dh-stage-trino

resources:
  - ../../../base/trino

generators:
  - secret-generator.yaml

images:
  - name: quay.io/opendatahub/trino:371
    newName: quay.io/opendatahub/trino
    newTag: 'development'

patchesJson6902:
  - patch: |
      - op: add
        path: /spec/applications/-
        value:
          kustomizeConfig:
            repoRef:
              name: idh
              path: odh-manifests/trino
          name: idh-trino
      - op: add
        path: /spec/repos/-
        value:
          name: idh
          uri: https://github.com/AICoE/internal-data-hub/tarball/main
    target:
      group: kfdef.apps.kubeflow.org
      kind: KfDef
      name: opendatahub
      version: v1
  - patch: |
      - op: replace
        path: /data/s3_credentials_secret
        value: stage-aws-secret
    target:
      kind: ConfigMap
      name: trino-config
      version: v1
  - patch: |
      - op: replace
        path: /data/s3_endpoint_url
        value: s3.upshift.redhat.com
    target:
      kind: ConfigMap
      name: trino-config
      version: v1
  - patch: |
      - op: replace
        path: /data/trino_environment
        value: stage
    target:
      kind: ConfigMap
      name: trino-config
      version: v1
  - patch: |
      - op: replace
        path: /stringData/group-provider.properties
        value: |-
          group-provider.name=ldap
          ldap.url=ldaps://ldap.corp.redhat.com
          ldap.ssl.truststore.path=/etc/certs/RH-IT-Root-CA.crt
          ldap.user-base-dn=${ENV:LDAP_USER_BASE_DN}
          ldap.group-base-dn=${ENV:LDAP_GROUP_BASE_DN}
          ldap.user-bind-pattern=uid=${USER}
          ldap.group-search-filter=uniqueMember=${USER}
          ldap.bind-dn=${ENV:LDAP_BIND_DN}
          ldap.bind-password=${ENV:LDAP_BIND_PASSWORD}
    target:
      kind: Secret
      name: trino-config
      version: v1
  - patch: |
      - op: replace
        path: /stringData/ldap-authenticator.properties
        value: |-
          password-authenticator.name=ldap
          ldap.url=ldaps://ldap.corp.redhat.com
          ldap.ssl.truststore.path=/etc/certs/RH-IT-Root-CA.crt
          ldap.user-bind-pattern=uid=${USER},ou=Users,dc=redhat,dc=com
    target:
      kind: Secret
      name: trino-config
      version: v1
